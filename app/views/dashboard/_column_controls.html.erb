
<script type="text/javascript"><!--

$(document).ready(function() {

  var autoRefreshEnabled = "<%= @auto_refresh %>" === "true";
  var autoRefreshButton = $('#auto_refresh');    
  var autoRefreshLabel = $('#auto_refresh_label');

  var setRefreshButtonText = function() {
    if (autoRefreshEnabled) {
      autoRefreshLabel.text('== on');
    } else {
      autoRefreshLabel.text('== off');
    }    
  };
  
  var parse = function(name, current_value) {
    var input = $('#' + name);
    var newValue = parseInt(input.val());
    if (isNaN(newValue)) {
      input.attr('value', current_value);
    }
    return input.val();
  };
  
  var id = function() {
    return "<%= @kata.id %>";
  };
  
  var secondsPerColumn = function() {
    return parse('seconds_per_column', <%= @seconds_per_column %>);
  };
  
  var maximumColumns = function() {
    return parse('maximum_columns', <%= @maximum_columns %>);
  };
  
  var params = function() {
    return {
      id: id(),
      seconds_per_column: secondsPerColumn(),
      maximum_columns: maximumColumns(),
      auto_refresh: autoRefreshEnabled
    };
  };
  
  var dashboardHeartbeat = function() {
    if (autoRefreshEnabled) {
      $.ajax({
        url: '/dashboard/heartbeat',
        data: params(),
        dataType: "script"
      });
    }
  };

  var refreshDashboard = function() {
      var url = '/dashboard/show/' + id() + '?' +
                'seconds_per_column=' + secondsPerColumn() + '&' +
                'maximum_columns=' + maximumColumns() + '&' +
                'auto_refresh=' + autoRefreshEnabled;
      window.location = url;    
  };
  
  var seconds = 1000;    
  setInterval(dashboardHeartbeat, 10*seconds);
  
  $('#seconds_per_column,#maximum_columns').keyup(function(event) {
    if (event.keyCode === $.ui.keyCode.ENTER) {
      refreshDashboard();
    }
  });
  
  autoRefreshButton.click(function() {
    autoRefreshEnabled = !autoRefreshEnabled;
    setRefreshButtonText();
    if (autoRefreshEnabled) {
      refreshDashboard();
    }
  });
  
  setRefreshButtonText();
});

//--></script>

<table>
  <tr>
    <td class="align-right">
      <input type="text"
             id="seconds_per_column"
             value="<%= @seconds_per_column %>"/>
    </td>
    <td class="align-left">
      &thinsp;      
      <span id="seconds_per_column_text">
        <%= t("views.labels.seconds_per_column") %>
      </span>
    </td>
  </tr>
  
  <tr>
    <td class="align-right">
      <input type="text" 
             id="maximum_columns"
             value="<%= @maximum_columns %>"/>
    </td>
    <td class="align-left">
      &thinsp;
      <span id="maximum_columns_text">
        <%= t("views.labels.columns_maximum") %>
      </span>
    </td>
  </tr>

  <tr>
    <td class="align-right">
      <button type="button"
              class="tipped"
              id="auto_refresh">
        refresh
        <div class="tooltip">
          Toggle the 10 second<br>
          dashboard auto-refresh<br>
          on/off
        </div>
      </button>
    </td>
    <td class="align-left">
      &thinsp;
      <span id="auto_refresh_label">
        <%= t("views.labels.auto_refresh") %>
      </span>
    </td>
  </tr>
  
</table>
