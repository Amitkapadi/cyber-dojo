
<script type="text/javascript"><!--

(function($) {
  // http://stackoverflow.com/questions/4911577/jquery-click-toggle-between-two-functions
  // $(..).toggle() no longer exists in JQuery
  $.fn.clickToggle = function(func1, func2) {
    var funcs = [func1, func2];
    this.data('toggleclicked', 0);
    this.click(function() {
      var data = $(this).data();
      var tc = data.toggleclicked;
      $.proxy(funcs[tc], this)();
      data.toggleclicked = (tc + 1) % 2;
    });
    return this;
  };
}(jQuery));

$(document).ready(function() {

  // TODO: This buildDiffFilenameHandlers() call currently passes
  //       all of @diffs as a parameter.
  //       However, diff[:content] and diff[:line_numbers] are large
  //       and are not needed (here) now that each diff-view file has its
  //       own pair of divs (one for line-numbers and one for content)
  //       in _lined_diff.html.erb

  cd.buildDiffFilenameHandlers(<%= @diffs.to_json.html_safe %>);
  
  var display = function(node, name, value) {
    if ($(node).attr('disabled') !== 'disabled') {
      $(name).css('display', value);
    }
  };
  var allLineCountButtons = $('.diff-deleted-line-count, .diff-added-line-count');
  var off = { 'disabled':true, 'title':'' }; 
  var disableAllLineCountButtons = function() {
    allLineCountButtons.attr(off);
  };

  $('.filename').click(function() {
    var tr = $(this).parent().parent();
    disableAllLineCountButtons();
    tr.find('.diff-deleted-line-count')
        .attr('disabled', false)
        .attr('title', 'Toggle deleted lines on/off');
    tr.find('.diff-added-line-count')
        .attr('disabled', false)
        .attr('title', 'Toggle added lines on/off');    
  });

  $('.diff-deleted-line-count').clickToggle(
    function() { display(this, 'deleted', 'none' ); },
    function() { display(this, 'deleted', 'block'); }    
  );

  $('.diff-added-line-count').clickToggle(
    function() { display(this, 'added', 'none' ); },
    function() { display(this, 'added', 'block'); }    
  );

  disableAllLineCountButtons();
  $('#' + '<%= @current_filename_id %>').click();  
  $('input[type=radio]').hide();
  
});

//--></script>

<table>
  <% @diffs.each do |diff| %>
    <tr>
      <td class="align-left">        
        <div class="filename"
             id="<%= diff[:id] %>">
          <input id="radio_<%= diff[:id] %>"
                 name="filename"
                 type="radio"
                 checked="checked"
                 value="<%= diff[:filename] %>"/>
          <label>
            <%= diff[:filename] %>
          </label>
        </div>       
      </td>    
 
      <% n_deleted = diff[:deleted_line_count] %>
      <% if n_deleted > 0 %>
        <td class="align-right diff-deleted-line-count button">
            <%= n_deleted %>
        </td>            
      <% else %>
        <td class="align-right">
        </td>
      <% end %>
              
      <% n_added = diff[:added_line_count]   %>
      <% if n_added > 0 %>
        <td class="align-right diff-added-line-count button">
          <%= n_added %>
        </td>
      <% else %>
        <td class="align-right">
        </td>        
      <% end %>
      
    </tr>
  <% end %>
</table>
