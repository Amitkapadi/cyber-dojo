
<script language="JavaScript"
        type="text/javascript"><!--

$(document).ready(function() {

  var minTag = <%= @min_tag %>;
  var wasTag = <%= @was_tag %>;
  var wasTagAtLimit = minTag >= wasTag;
  
  var nowTag = <%= @now_tag %>;
  var maxTag = <%= @max_tag %>;  
  var nowTagAtLimit = nowTag >= maxTag;

  var tagGap = nowTag - wasTag;
  
  var showDiff = function(was, now) {
    var currentFilename = $('input:radio[name=filename]:checked').val();  
    cd.postTo('/diff/show', {
      id: "<%= @kata.id %>",
      avatar: "<%= @avatar.name %>",
      was_tag: was,
      now_tag: now,
      current_filename: currentFilename
    });
  };

  var toolTip = function(was, now) {
    if (was !== now) {
      return 'Show diff ' + was + '->' + now;
    } else {
      return 'Show ' + was;
    }
  };
  
  var wasTagNumber = $('#was_tag_number');
  var nowTagNumber = $('#now_tag_number');

  var firstButton = $('#first_button');
  var  prevButton = $('#prev_button');
  var  nextButton = $('#next_button');
  var  lastButton = $('#last_button');
  
  var tagEdit = function(event) {
    if (event.keyCode === $.ui.keyCode.ENTER) {
      var newWasTag = parseInt(wasTagNumber.attr('value'), 10);
      var newNowTag = parseInt(nowTagNumber.attr('value'), 10);      
      if (isNaN(newWasTag) || newWasTag < minTag ||
            isNaN(newNowTag) || newNowTag > maxTag ||
              newWasTag > newNowTag) {
        wasTagNumber.attr('value', wasTag);
        nowTagNumber.attr('value', nowTag);
      } else {
        showDiff(newWasTag, newNowTag);
      }
    }        
  };
  
  wasTagNumber.unbind('keyup').keyup(function(event) { tagEdit(event); });  
  nowTagNumber.unbind('keyup').keyup(function(event) { tagEdit(event); });
  
  firstButton.attr('disabled', wasTagAtLimit);
   prevButton.attr('disabled', wasTagAtLimit);
  if (!wasTagAtLimit) {
    firstButton.unbind('click')
               .click(function() { showDiff(minTag, minTag + tagGap); })
               .attr('title', toolTip(minTag, minTag + tagGap));	  
     prevButton.unbind('click')
               .click(function() { showDiff(wasTag - 1, nowTag - 1); })
               .attr('title', toolTip(wasTag - 1, nowTag - 1));
  }
  
  nextButton.attr('disabled', nowTagAtLimit);
  lastButton.attr('disabled', nowTagAtLimit);  
  if (!nowTagAtLimit) {
    nextButton.unbind('click')
              .click(function() { showDiff(wasTag + 1, nowTag + 1); })
              .attr('title', toolTip(wasTag + 1, nowTag + 1));			  
    lastButton.unbind('click')
              .click(function() { showDiff(maxTag - tagGap, maxTag); })
              .attr('title', toolTip(maxTag - tagGap, maxTag));	
  }

});

//--></script>
