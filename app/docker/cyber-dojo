#!/bin/sh
set -e

# TODO: add command to backup katas-data-container to tar.tgz file
#       See end of https://docs.docker.com/engine/userguide/containers/dockervolumes/#manage-data-in-containers
#       Should be able to use this technique to create the initial
#       full data-container (new server on top of old one)
# TODO: check this script works if called from any drectory
# TODO: create katas-DATA-CONTAINER only if RUNNER=DockerKatasDataContainerRunner?
# TODO: pull all language images == fetch? all?

ME="./$( basename ${0} )"
MY_DIR="$( cd "$( dirname "${0}" )" && pwd )"

GITHUB_URL=https://raw.githubusercontent.com/JonJagger/cyber-dojo/master/docker

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

show_use()
{
  echo
  echo "Use: ${ME} COMMAND"
  echo "     ${ME} help"
  echo
  echo 'COMMAND(server):'
  # TODO: backup a katas-ID data-container
  echo '     down                 Stops and removes server'
  echo '     up                   Creates and starts the server'
  echo
  echo 'COMMAND(languages):'
  echo '     images               Lists pulled languages'
  echo '     pull=IMAGE           Pulls language IMAGE'
  echo '     catalog              Lists all languages'
  echo '     rmi=IMAGE            Removes a pulled language IMAGE'
  echo '     upgrade              Pulls the latest server and languages'
  echo
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# process command-line args

COUNT=0
for ARG in "$@"
do
  case ${ARG} in
    # - - - - - - - server - - - - - - - -
    down)
      doDown=true
      COUNT=$((COUNT + 1))
      ;;
    up)
      doUp=true
      COUNT=$((COUNT + 1))
      ;;
    # - - - - - - - up options - - - - - - - -
    katas=*)
      KATAS="${ARG#*=}"
      ;;
    runner=*)
      RUNNER="${ARG#*=}"
      ;;
    # - - - - - - - languages - - - - - - - -
    images)
      COUNT=$((COUNT + 1))
      ;;
    pull=*)
      COUNT=$((COUNT + 1))
      ;;
    catalog)
      COUNT=$((COUNT + 1))
      ;;
    rmi=*)
      COUNT=$((COUNT + 1))
      ;;
    upgrade)
      COUNT=$((COUNT + 1))
      ;;
    # - - - - - - - - - - - - - - -
    help)
      doHelp=true
      ;;
    # - - - - - - - something's not right - - - - - - - -
    *)
      echo "${ME}: ${ARG} ?"
      echo "See '${ME} help"
      exit
      ;;
  esac
done

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# nothing is implicit

if ((${COUNT} > 1)); then
  echo 'one command only please'
  echo "See '${ME} help'"
  exit
fi

if [ -n "${doHelp}" ]; then
  show_use;
  exit;
fi

if [ $# -eq 0 ]; then
  echo 'no command entered'
  echo "See '${ME} help'"
  exit
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# install docker if necessary

hash docker 2> /dev/null
if [ $? != 0 ]; then
  echo
  echo 'cyber-dojo is installing docker'
  SCRIPT=install-docker.sh
  curl -O ${GITHUB_URL}/${SCRIPT}
  chmod +x ${SCRIPT}
  ./${SCRIPT}
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# install docker-machine if necessary

hash docker-machine 2> /dev/null
if [ $? != 0 ]; then
  echo
  echo 'cyber-dojo is installing docker-machine'
  SCRIPT=install-docker-machine.sh
  curl -O ${GITHUB_URL}/${SCRIPT}
  chmod +x ${SCRIPT}
  ./${SCRIPT}
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# install docker-compose if necessary

hash docker-compose 2> /dev/null
if [ $? != 0 ]; then
  echo
  echo 'cyber-dojo is installing docker-compose'
  SCRIPT=install-docker-compose.sh
  curl -O ${GITHUB_URL}/${SCRIPT}
  chmod +x ${SCRIPT}
  ./${SCRIPT}
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# you must have the docker-compose.yml file

DOCKER_COMPOSE_FILE=docker-compose.yml
DOCKER_COMPOSE_CMD="docker-compose --file=./${DOCKER_COMPOSE_FILE}"

if [ ! -e ${MY_DIR}/${DOCKER_COMPOSE_FILE} ]; then
  CWD=$(pwd)
  cd "${MY_DIR}" > /dev/null
  curl -O ${GITHUB_URL}/${DOCKER_COMPOSE_FILE}
  cd "${CWD}" > /dev/null
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# docker-compose.yml relies on several exported env-vars

RUNNER_DEFAULT=DockerTarPipeRunner
RUNNER=${RUNNER_DEFAULT}         # see app/models/dojo.rb
HOME=/usr/src/cyber-dojo         # home folder *inside* the server image

export CYBER_DOJO_HOME=${HOME}
export CYBER_DOJO_KATAS_ROOT=${HOME}/katas
export CYBER_DOJO_KATAS_CLASS=HostDiskKatas
export CYBER_DOJO_RUNNER_CLASS=${RUNNER}
export CYBER_DOJO_RUNNER_SUDO='sudo -u docker-runner sudo'
export CYBER_DOJO_RUNNER_TIMEOUT=10


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# delegate to ruby script inside web image

docker run \
  --rm \
  --user=cyber-dojo \
  cyberdojofoundation/web \
  sh -c "./app/docker/cyber-dojo.rb $@"


if [ -n "${doDown}" ]; then
  CWD=$(pwd)
  cd "${MY_DIR}" > /dev/null
  ${DOCKER_COMPOSE_CMD} down
  cd "${CWD}" > /dev/null
fi

if [ -n "${doUp}" ]; then
  CWD=$(pwd)
  cd "${MY_DIR}" > /dev/null
  ${DOCKER_COMPOSE_CMD} up -d
  cd "${CWD}" > /dev/null
fi

