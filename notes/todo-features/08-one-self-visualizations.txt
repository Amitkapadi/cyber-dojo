
'diff-added' =>
'diff-deleted' =>
'seconds-since-last-traffic-light' => ...

Idea is to visualize 3 simple histograms
Each test event creates a bar. Bar is coloured
red/amber/green to match its test outcome.
Height of bar is value of 
1. diff-added (1st histogram)
2. diff-deleted (2nd histogram)
3. seconds-since-last-traffic-light (3rd histogram)
-----------------------------------------------------


OneSelf.rb
how to get seconds since last 'event'
tag==1 is the first test event
so if Tag.rb had time in the same way Light.rb has I could
s_new = avatar.tags[tag].time
s_old = avatar.tags[tag-1].time
(s_new - s_old)
...
class Avatar
  def tags
    Tags.new(self)
  end
  def lights
    tags.select{ |tag| tag.has-field 'colour' }
  end
end
...and...
when avatar starts, put an entry into increments.json with the
current time which is the avatar's start time
   {
     'event' => 'created',
     'time' => [2014, 2, 15, 8, 54, 6],
     'number' => 0
   },
However... I could do this in the method itself!
I don't need to store that on the disk...

class Avatar
  # return a hash here?
  def tags
    @tags ||= increments.inject(Hash.new([])) {|i,h| i[h['number']] = Tag.new(self,h);i}    
  end
  def lights
    tags.select{ |tag| tag.light? }.values
  end  
private
  def increments
    @increments ||= zeroth << JSON.parse(read(increments_filename))
  end
  def zeroth
    [
       'event' => 'created',
       'time' => time_now(avatar.kata.created),
       'number' => '0'
    ]
  end
end

and this allows...

class Tag
  include ExternalParentChain
  
  def initialize(avatar,hash)
    @parent,@hash = avatar,hash
  end  
  
  def avatar
    @parent
  end

  def visible_files
    @manifest ||= JSON.parse(git.show(path, "#{number}:manifest.json"))
  end

  def output
    visible_files['output'] || ''
  end

  def time
    # todo: times need to come from browser
    #       and use iso8601
    Time.mktime(*hash['time'])
  end

  def light?
    hash.include?('colour') || hash.include?('outcome')
  end
  
  def colour
    # todo: if this is called on tag that is not a light
    # it will raise a NoMethodError
    (hash['colour'] || hash['outcome']).to_sym
  end

  # This is used in differ_controller.rb
  def to_json
    {
      'colour' => colour,
      'time'   => time,
      'number' => number
    }
  end

  def number
    # badly named but can't rename
    # could it be made private?
    # Is it still needed if Tag and Light merge?
    hash['number']
  end
  
private

  attr_reader :hash
        
  def path
    @parent.path
  end
  
end
   

